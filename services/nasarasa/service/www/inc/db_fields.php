<?php
    require_once __DIR__ . '/db.php';
    require_once __DIR__ . '/logging.php';

    class DbField
    {
        private $is_primary_key = false;
        public $is_unique = false;
        public $need_escape = true;

        protected $type_definition = 'UNKNOWN';
        
        function __construct($options=[])
        {
            if (array_key_exists('primary_key', $options))
                $this->is_primary_key = (bool) $options['primary_key'];
            if (array_key_exists('unique', $options))
                $this->is_unique = (bool) $options['unique'];
        }

        public function get_type_definition()
        {
            $type = $this->type_definition;
            if ($this->is_primary_key)
                $type .= ' PRIMARY KEY';
            return $type;
        }

        public function can_assign_value($value)
        {
            return true;
        }

        public function modify_on_set($value)
        {
            return $value;
        }

        public function modify_on_get($value)
        {
            return $value;
        }
    }

    class DbNumberField extends DbField
    {
        protected $min_value = null;
        protected $max_value = null;

        function __construct($options=[])
        {
            parent::__construct($options);

            if (array_key_exists('min_value', $options))
                $this->min_value = (int) $options['min_value'];

            if (array_key_exists('max_value', $options))
                $this->max_value = (int) $options['max_value'];
        }

        public function can_assign_value($value)
        {
            if (! parent::can_assign_value($value))
                return false;

            if (! is_numeric($value))
                return false;

            if ($this->min_value != null && $value < $this->min_value)
                throw new DbConstraintsException('Value must be not less than ' . $this->min_value);
            if ($this->max_value != null && $value > $this->max_value)
                throw new DbConstraintsException('Value must be not more than ' . $this->max_value);

            return true;
        }
    }

    class DbIntField extends DbNumberField
    {
        private $is_auto_increment = false;

        function __construct($options=[])
        {
            parent::__construct($options);

            if (array_key_exists('auto_increment', $options))
                $this->is_auto_increment = (bool) $options['auto_increment'];

            $this->type_definition = 'INT' . ($this->is_auto_increment ? ' AUTO_INCREMENT' : '');
        }

        public function can_assign_value($value)
        {            
            if (! parent::can_assign_value($value))
                return false;

            if (! is_int($value))
                throw new DbConstraintsException('Value must be integer');

            return true;
        }
    }

    class DbDoubleField extends DbNumberField
    {
        function __construct($options=[])
        {
            parent::__construct($options);

            $this->type_definition = 'DOUBLE PRECISION';
        }

        public function can_assign_value($value)
        {            
            if (! parent::can_assign_value($value))
                return false;

            if (! is_double($value))
                throw new DbConstraintsException('Value must be double');

            return true;
        }
    }

    class DbCharField extends DbField
    {
        const DEFAULT_MAX_LENGTH = 255;

        private $max_length = self::DEFAULT_MAX_LENGTH;

        function __construct($options=[])
        {
            parent::__construct($options);

            if (array_key_exists('max_length', $options))
                $this->max_length = (int) $options['max_length'];

            if ($this->max_length <= 0 || $this->max_length > 10000)
            {
                warning('Wrong max_length: ' . $this->max_length);
                $this->max_length = self::DEFAULT_MAX_LENGTH;
            }

            $this->type_definition = 'VARCHAR(' . $this->max_length . ')';
        }
    }

    class DbForeignField extends DbField
    {
        private $class;

        function __construct($options=[])
        {
            parent::__construct($options);

            if (! array_key_exists('to', $options))
                throw new DbException('You should define `to` option for foreign key');
 
            $this->class = (string) $options['to'];
            try
            {
                $obj = new $this->class;
            }
            catch (Exception $e)
            {
                throw new DbException('Can\'t find model for foreign key: ' . $this->class);
            }
            if (! is_subclass_of($this->class, 'DbModel'))
                throw new DbException('Foreign key\'s model (' . $this->class . ') should extend DbModel');

            $this->type_definition = 'INT';
        }

        public function can_assign_value($value)
        {
            if (get_class($value) != $this->class)
                throw new InvalidValidException('This field must be ' . $this->class . ' type');
            return true;
        }

        public function modify_on_set($value)
        {
            debug('ForeignKey(' . $this->class . ')::modify_on_set(' . var_export($value, true) . ')');
            $pk = $value->get_primary_key();
            return $value->$pk;
        }

        public function modify_on_get($value)
        {
            $class = $this->class;
            return $class::find_one(['__pk__' => $value]);
        }
    }

    class DbTimeField extends DbField
    {
        private $init_with_current_timestamp;

        function __construct($options=[])
        {
            parent::__construct($options);

            if (array_key_exists('init_with_current_timestamp', $options))
                $this->init_with_current_timestamp = (bool) $options['init_with_current_timestamp'];

            $this->type_definition = 'TIMESTAMP';
            if ($this->init_with_current_timestamp)
                $this->type_definition .= ' DEFAULT CURRENT_TIMESTAMP';
        }        
    }
?>